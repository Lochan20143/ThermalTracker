<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ThermalTrack: Advanced Heat Signature Detection</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'cyber-blue': '#00f3ff',
            'cyber-purple': '#9d00ff',
            'cyber-pink': '#ff00f7',
            'cyber-yellow': '#ffde03',
            'cyber-green': '#00ff9f',
          },
          animation: {
            'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'glow': 'glow 2s ease-in-out infinite alternate',
            'scan': 'scan 3s linear infinite',
          },
          keyframes: {
            glow: {
              '0%': { boxShadow: '0 0 5px #00f3ff, 0 0 10px #00f3ff' },
              '100%': { boxShadow: '0 0 20px #00f3ff, 0 0 30px #00f3ff' }
            },
            scan: {
              '0%': { backgroundPosition: '0% 0%' },
              '100%': { backgroundPosition: '100% 100%' }
            }
          },
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap');
    
    body {
      font-family: 'Rajdhani', sans-serif;
      background-color: #0a0a1a;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(0, 243, 255, 0.05) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(157, 0, 255, 0.05) 0%, transparent 20%),
        linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
      background-attachment: fixed;
    }
    
    .orbitron {
      font-family: 'Orbitron', sans-serif;
    }
    
    .cyber-border {
      position: relative;
      border: 1px solid rgba(0, 243, 255, 0.3);
    }
    
    .cyber-border::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      border: 1px solid rgba(0, 243, 255, 0.3);
      animation: glow 2s ease-in-out infinite alternate;
      pointer-events: none;
    }
    
    .scan-line {
      background: linear-gradient(90deg, transparent, rgba(0, 243, 255, 0.2), transparent);
      background-size: 200% 100%;
      animation: scan 3s linear infinite;
    }
    
    .hexagon {
      clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
    }
    
    .control-panel {
      background: rgba(10, 10, 26, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 243, 255, 0.3);
    }
    
    .cyber-button {
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .cyber-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: all 0.6s ease;
    }
    
    .cyber-button:hover::before {
      left: 100%;
    }
    
    .data-display {
      font-family: 'Orbitron', monospace;
      color: #00f3ff;
      text-shadow: 0 0 5px rgba(0, 243, 255, 0.7);
    }
    
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }
    
    .status-active {
      background-color: #00ff9f;
      box-shadow: 0 0 10px #00ff9f;
      animation: pulse 1.5s infinite;
    }
    
    .status-inactive {
      background-color: #ff00f7;
      box-shadow: 0 0 10px #ff00f7;
    }
  </style>
</head>
<body class="text-gray-200 min-h-screen">

  <!-- Header with animated title -->
  <header class="pt-6 pb-2 px-4">
    <div class="container mx-auto flex flex-col items-center">
      <div class="flex items-center mb-2">
        <div class="w-3 h-3 bg-cyber-blue rounded-full animate-pulse mr-2"></div>
        <div class="w-3 h-3 bg-cyber-purple rounded-full animate-pulse-fast mr-2"></div>
        <div class="w-3 h-3 bg-cyber-pink rounded-full animate-pulse mr-2"></div>
      </div>
      <h1 class="orbitron text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyber-blue via-cyber-purple to-cyber-pink text-center leading-tight">
        THERMAL<span class="text-cyber-yellow">TRACK</span>
      </h1>
      <p class="text-sm text-center text-gray-400 mt-1 max-w-md">ADVANCED HEAT SIGNATURE DETECTION SYSTEM v1.0</p>
      <div class="w-full max-w-md h-0.5 bg-gradient-to-r from-transparent via-cyber-blue to-transparent mt-3"></div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6">
    <!-- Main display area -->
    <div class="flex flex-col lg:flex-row gap-6">
      <!-- Video feed container -->
      <div class="lg:w-2/3 relative">
        <div class="cyber-border rounded-lg overflow-hidden relative">
          <!-- Status bar -->
          <div class="absolute top-0 left-0 right-0 bg-black bg-opacity-70 p-2 z-10 flex justify-between items-center text-xs">
            <div>
              <span class="status-indicator" id="irStatusIndicator"></span>
              <span id="irStatusText">IR MODE</span>
            </div>
            <div class="data-display">
              <i class="fas fa-clock mr-1"></i>
              <span id="currentTime"></span>
            </div>
            <div>
              <span class="status-indicator" id="stabilizationIndicator"></span>
              <span id="stabilizationText">STABILIZATION</span>
            </div>
          </div>
          
          <!-- Video feed -->
          <img src="{{ url_for('video_feed') }}" 
               class="w-full rounded-lg" 
               id="liveStream">
          
          <!-- Scan line effect -->
          <div class="scan-line absolute top-0 left-0 right-0 h-full pointer-events-none"></div>
          
          <!-- Corner decorations -->
          <div class="absolute top-0 left-0 w-6 h-6 border-t-2 border-l-2 border-cyber-blue"></div>
          <div class="absolute top-0 right-0 w-6 h-6 border-t-2 border-r-2 border-cyber-blue"></div>
          <div class="absolute bottom-0 left-0 w-6 h-6 border-b-2 border-l-2 border-cyber-blue"></div>
          <div class="absolute bottom-0 right-0 w-6 h-6 border-b-2 border-r-2 border-cyber-blue"></div>
        </div>
        
        <!-- Detection info panel -->
        <div class="mt-4 control-panel rounded-lg p-3 text-sm">
          <div class="flex justify-between items-center">
            <h3 class="orbitron text-cyber-blue">DETECTION STATUS</h3>
            <div class="data-display text-xs" id="detectionCounter">OBJECTS: 0</div>
          </div>
          <div class="grid grid-cols-2 gap-2 mt-2">
            <div class="bg-black bg-opacity-50 p-2 rounded">
              <div class="text-xs text-gray-400">TEMPERATURE</div>
              <div class="data-display" id="tempReading">-- °C</div>
            </div>
            <div class="bg-black bg-opacity-50 p-2 rounded">
              <div class="text-xs text-gray-400">CONFIDENCE</div>
              <div class="data-display" id="confidenceReading">--%</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Control panel -->
      <div class="lg:w-1/3">
        <div class="control-panel rounded-lg p-4">
          <h2 class="orbitron text-xl text-cyber-green mb-4">SYSTEM CONTROLS</h2>
          
          <!-- Control buttons -->
          <div class="grid grid-cols-1 gap-3 mb-6">
            <button id="toggleIRBtn" class="cyber-button bg-gradient-to-r from-cyber-blue to-cyber-purple text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-between">
              <span><i class="fas fa-temperature-high mr-2"></i> TOGGLE IR MODE</span>
              <i class="fas fa-chevron-right"></i>
            </button>
            
            <button id="stabiliseBtn" class="cyber-button bg-gradient-to-r from-cyber-purple to-cyber-pink text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-between">
              <span><i class="fas fa-video mr-2"></i> TOGGLE STABILIZATION</span>
              <i class="fas fa-chevron-right"></i>
            </button>
            
            <button id="classifyBtn" class="cyber-button bg-gradient-to-r from-cyber-pink to-cyber-yellow text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-between">
              <span><i class="fas fa-brain mr-2"></i> CLASSIFY IMAGE</span>
              <i class="fas fa-chevron-right"></i>
            </button>
            
            <button id="processVideoBtn" class="cyber-button bg-gradient-to-r from-cyber-yellow to-cyber-green text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-between disabled:opacity-50" disabled>
              <span><i class="fas fa-play mr-2"></i> PROCESS VIDEO IR</span>
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
          
          <!-- File upload -->
          <div class="mb-6">
            <h3 class="orbitron text-cyber-yellow text-sm mb-2">UPLOAD MEDIA</h3>
            <label class="cyber-border rounded-lg p-1 block w-full cursor-pointer hover:bg-black hover:bg-opacity-30 transition">
              <div class="bg-black bg-opacity-50 rounded-lg p-3 flex items-center">
                <i class="fas fa-upload text-cyber-blue mr-3 text-xl"></i>
                <div class="flex-1">
                  <div class="text-sm font-medium">SELECT VIDEO/IMAGE</div>
                  <div class="text-xs text-gray-400" id="fileNameDisplay">No file selected</div>
                </div>
              </div>
              <input id="fileUpload" type="file" accept="video/*,image/*" class="hidden"/>
            </label>
            
            <!-- Video controls -->
            <div id="videoControls" class="hidden mt-3 grid grid-cols-2 gap-2">
              <button id="viewOriginalBtn" class="cyber-button bg-gray-700 text-white py-2 px-3 rounded text-sm">
                <i class="fas fa-eye mr-1"></i> ORIGINAL
              </button>
              <button id="viewProcessedBtn" class="cyber-button bg-cyber-blue text-white py-2 px-3 rounded text-sm">
                <i class="fas fa-fire mr-1"></i> IR PROCESSED
              </button>
            </div>
          </div>
          
          <!-- Analysis results -->
          <div class="bg-black bg-opacity-50 rounded-lg p-4">
            <h3 class="orbitron text-cyber-green text-sm mb-3">ANALYSIS RESULTS</h3>
            <div id="analysisResults" class="text-sm text-gray-300">
              <div class="flex items-center justify-center h-20 text-gray-500">
                <i class="fas fa-database mr-2"></i> No data available
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Upload Preview -->
    <div class="mt-6 cyber-border rounded-lg p-1 overflow-hidden hidden" id="previewContainer">
      <div class="bg-black bg-opacity-70 p-2 flex justify-between items-center">
        <h3 class="orbitron text-cyber-yellow text-sm">MEDIA PREVIEW</h3>
        <div class="flex items-center gap-2">
          <span id="videoProcessingStatus" class="text-xs text-gray-400"></span>
          <button id="closePreviewBtn" class="text-gray-400 hover:text-cyber-pink">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="relative">
        <img id="uploadedImage" class="hidden w-full rounded-b-lg" />
        <img id="uploadedVideo" class="hidden w-full rounded-b-lg" />
      </div>
    </div>
  </main>

  <script>
    // Update status indicators based on current state
    function updateStatusIndicators(irMode, stabilization) {
      const irIndicator = document.getElementById('irStatusIndicator');
      const irText = document.getElementById('irStatusText');
      const stabIndicator = document.getElementById('stabilizationIndicator');
      const stabText = document.getElementById('stabilizationText');
      
      if (irMode) {
        irIndicator.className = 'status-indicator status-active';
        irText.textContent = 'IR MODE: ACTIVE';
      } else {
        irIndicator.className = 'status-indicator status-inactive';
        irText.textContent = 'IR MODE: INACTIVE';
      }
      
      if (stabilization) {
        stabIndicator.className = 'status-indicator status-active';
        stabText.textContent = 'STABILIZATION: ACTIVE';
      } else {
        stabIndicator.className = 'status-indicator status-inactive';
        stabText.textContent = 'STABILIZATION: INACTIVE';
      }
    }
    
    // Initialize with default values
    let irModeActive = true;
    let stabilizationActive = false;
    updateStatusIndicators(irModeActive, stabilizationActive);
    
    // Update time
    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').textContent = 
        now.toLocaleTimeString('en-US', { hour12: false });
    }
    setInterval(updateTime, 1000);
    updateTime();
    
    // Toggle IR Mode
    document.getElementById("toggleIRBtn").addEventListener("click", () => {
      fetch("/toggle_ir", { method: "POST" })
        .then(response => response.json())
        .then(data => {
          console.log(data.status);
          irModeActive = !irModeActive;
          updateStatusIndicators(irModeActive, stabilizationActive);
        });
    });

    // Toggle Stabilization
    document.getElementById("stabiliseBtn").addEventListener("click", () => {
      fetch("/toggle_stabilisation", { method: "POST" })
        .then(response => response.json())
        .then(data => {
          console.log(data.status);
          stabilizationActive = !stabilizationActive;
          updateStatusIndicators(irModeActive, stabilizationActive);
        });
    });

    // Classify Image
    document.getElementById("classifyBtn").addEventListener("click", async () => {
      const fileInput = document.getElementById("fileUpload");
      const image = fileInput.files[0];
      if (!image || !image.type.startsWith("image")) {
        showNotification("Please select an image to classify", "error");
        return;
      }

      const formData = new FormData();
      formData.append("file", image);

      try {
        showNotification("Analyzing image...", "info");
        const res = await fetch("/classify_image", {
          method: "POST",
          body: formData
        });

        const result = await res.json();
        if (result.error) {
          showNotification(result.error, "error");
          return;
        }
        
        // Update analysis results
        const analysisResults = document.getElementById('analysisResults');
        analysisResults.innerHTML = `
          <div class="mb-2">
            <span class="text-gray-400">OBJECT:</span> 
            <span class="text-cyber-green font-semibold">${result.label}</span>
          </div>
          <div>
            <span class="text-gray-400">CONFIDENCE:</span>
            <div class="w-full bg-gray-700 rounded-full h-2 mt-1">
              <div class="bg-cyber-green h-2 rounded-full" style="width: ${result.confidence}%"></div>
            </div>
            <div class="text-right text-xs mt-1">${result.confidence}%</div>
          </div>
        `;
        
        // Update confidence reading
        document.getElementById('confidenceReading').textContent = `${result.confidence}%`;
        
        showNotification(`Identified as ${result.label} with ${result.confidence}% confidence`, "success");
      } catch (error) {
        showNotification("Error analyzing image", "error");
        console.error(error);
      }
    });

    // Notification system
    function showNotification(message, type = "info") {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-lg z-50 flex items-center max-w-sm transition-all transform translate-y-0 opacity-100`;
      
      // Set background color based on type
      if (type === "error") {
        notification.classList.add('bg-red-900', 'text-white');
        notification.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i> ${message}`;
      } else if (type === "success") {
        notification.classList.add('bg-cyber-green', 'text-black');
        notification.innerHTML = `<i class="fas fa-check-circle mr-2"></i> ${message}`;
      } else {
        notification.classList.add('bg-cyber-blue', 'text-black');
        notification.innerHTML = `<i class="fas fa-info-circle mr-2"></i> ${message}`;
      }
      
      // Add to DOM
      document.body.appendChild(notification);
      
      // Remove after 3 seconds
      setTimeout(() => {
        notification.classList.add('opacity-0', 'translate-y-2');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
    
    // Simulate detection data updates (for demo purposes)
    function updateDetectionData() {
      // Random number of detected objects (0-5)
      const objectCount = Math.floor(Math.random() * 6);
      document.getElementById('detectionCounter').textContent = `OBJECTS: ${objectCount}`;
      
      // Random temperature between 20-40°C
      const temperature = (20 + Math.random() * 20).toFixed(1);
      document.getElementById('tempReading').textContent = `${temperature} °C`;
    }
    
    // Update detection data every 3 seconds
    setInterval(updateDetectionData, 3000);
    updateDetectionData();
    
    let uploadedVideoFile = null;
    let hasProcessedVideo = false;

    // File Upload Preview
    const fileInput = document.getElementById("fileUpload");
    const videoPreview = document.getElementById("uploadedVideo");
    const imagePreview = document.getElementById("uploadedImage");
    const previewContainer = document.getElementById("previewContainer");
    const fileNameDisplay = document.getElementById("fileNameDisplay");
    const processVideoBtn = document.getElementById("processVideoBtn");
    const videoControls = document.getElementById("videoControls");

    fileInput.addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      // Update file name display
      fileNameDisplay.textContent = file.name;
      
      const isVideo = file.type.startsWith("video");
      const isImage = file.type.startsWith("image");

      if (isVideo) {
        uploadedVideoFile = file;
        processVideoBtn.disabled = false;
        processVideoBtn.classList.remove('opacity-50');
        
        try {
          showNotification("Uploading video...", "info");
          const formData = new FormData();
          formData.append("file", file);
          
          const response = await fetch("/upload_video", {
            method: "POST",
            body: formData
          });
          const result = await response.json();
          
          if (result.original_url) {
            videoPreview.src = result.original_url;
            videoPreview.classList.remove("hidden");
            imagePreview.classList.add("hidden");
            previewContainer.classList.remove("hidden");
            videoControls.classList.remove("hidden");
            
            document.getElementById("videoProcessingStatus").textContent = "Video uploaded - Ready for IR processing";
            showNotification("Video uploaded successfully", "success");
          }
        } catch (error) {
          showNotification("Error uploading video", "error");
          console.error(error);
        }
      } else if (isImage) {
        processVideoBtn.disabled = true;
        processVideoBtn.classList.add('opacity-50');
        videoControls.classList.add("hidden");
        
        const fileURL = URL.createObjectURL(file);
        imagePreview.src = fileURL;
        imagePreview.classList.remove("hidden");
        videoPreview.classList.add("hidden");
        previewContainer.classList.remove("hidden");
      }
    });
    
    // Process Video with IR Detection
    document.getElementById("processVideoBtn").addEventListener("click", async () => {
      if (!uploadedVideoFile) {
        showNotification("Please upload a video first", "error");
        return;
      }
      
      try {
        showNotification("Processing video with IR detection...", "info");
        document.getElementById("videoProcessingStatus").textContent = "Processing with IR detection...";
        
        const response = await fetch("/process_uploaded_video", {
          method: "POST"
        });
        
        const result = await response.json();
        
        if (result.error) {
          showNotification(result.error, "error");
          return;
        }
        
        hasProcessedVideo = true;
        document.getElementById("videoProcessingStatus").textContent = "IR processing complete";
        
        // Update analysis results with detection data
        const analysisResults = document.getElementById('analysisResults');
        if (result.detections) {
          analysisResults.innerHTML = `
            <div class="mb-2">
              <span class="text-gray-400">TOTAL FRAMES:</span> 
              <span class="text-cyber-green font-semibold">${result.detections.total_frames}</span>
            </div>
            <div class="mb-2">
              <span class="text-gray-400">DETECTIONS:</span>
              <span class="text-cyber-yellow font-semibold">${result.detections.total_detections}</span>
            </div>
            <div class="text-xs text-gray-400 mt-2">
              Multi-angle IR analysis complete
            </div>
          `;
        }
        
        showNotification("Video processed with IR detection", "success");
        
      } catch (error) {
        showNotification("Error processing video", "error");
        console.error(error);
      }
    });
    
    // Video view controls
    document.getElementById("viewOriginalBtn").addEventListener("click", () => {
      if (uploadedVideoFile) {
        videoPreview.src = "/video_playback";
        showNotification("Showing original video", "info");
      }
    });
    
    document.getElementById("viewProcessedBtn").addEventListener("click", () => {
      if (hasProcessedVideo) {
        videoPreview.src = "/processed_video_playback";
        showNotification("Showing IR processed video", "info");
      } else {
        showNotification("Please process the video first", "error");
      }
    });
  </script>
</body>
</html>
